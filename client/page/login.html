<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>登录</title>
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <link rel="stylesheet" href="http://i.gtimg.cn/vipstyle/frozenui/2.0.0/css/frozen.css">
    <link rel="stylesheet" href="../css/login.css">
</head>
<body>

<div ng-app="loginPage" ng-controller="login" id="login">
    <div class="ui-tooltips ui-tooltips-warn" ng-if="errMessage!=''" style="position: absolute"
         ng-click="hiddenMessage()">
        <div class="ui-tooltips-cnt ui-tooltips-cnt-link ui-border-b">
            <i></i>{{errMessage}}
        </div>
    </div>
    <!--  登录-->
    <div class="login" ng-hide="status!='login'">
        <h1 class="login-title">QIM</h1>
        <div><input ng-model="loginPhone" class="login-phone-input" placeholder='手机号' type="text"></div>
        <div><input ng-model="loginPassword"
                    class="login-password-input" placeholder='输入密码'
                    type="password"></div>
        <div class="login-btn" ng-click="login()">
            <img ng-src="{{loginImageUrl}}">
        </div>
        <div class="login-tab">
            <span>忘记密码</span>
            <span>|</span>
            <span ng-click="changStatus('getCode')">注册</span>
        </div>
    </div>
    <!--  获取验证码-->
    <div class="register" ng-hide="status!='getCode'">
        <div class="register-input-box">
            <h1 class="register-title" style="text-align: center">注册</h1>
        </div>
        <div class="register-input-box">
            <input ng-model="phone" type="text" class="register-phone-input" placeholder="输入手机号">
        </div>
        <div class="register-input-box">
            <input ng-model="code" type="text" class="register-phone-input register-captcha-input" placeholder="输入验证码"
                   style="display: inline-block">
            <button ng-click="getCode()" class="register-captcha-btn"
                    ng-style="{'display':codeTimerShow == false ? 'inline-block' : 'none' }">{{codeTips}}
            </button>
            <button class="register-captcha-btn"
                    ng-style="{'display':codeTimerShow == true ? 'inline-block' : 'none' }">{{codeTimer}}s
            </button>
        </div>
        <div class="register-input-box">
            <input ng-model="passwordRegister" class="register-phone-input" type="password" placeholder="输入密码">
        </div>
        <div class="register-input-box">
            <button class="ui-btn-lg ui-btn-primary register-btn" ng-click="status='login'">返回</button>
            <button class="ui-btn-lg ui-btn-primary register-btn" style="float: right" ng-click="register()">注册
            </button>
        </div>
    </div>
</div>


<script src="https://cdn.staticfile.org/angular.js/1.4.6/angular.min.js"></script>

<script>
    var app = angular.module('loginPage', []);
    app.controller('login', function ($scope, $http, $interval) {
        $scope.getCodeText = "获取验证码";
        $scope.status = 'login';
        $scope.loginPhone = '';
        $scope.loginPassword = '';
        $scope.phone = '';
        $scope.code = '';
        $scope.codeTimer = 60;
        $scope.codeTimerShow = false;
        $scope.codeTips = "获取验证码";
        $scope.passwordRegister = '';
        $scope.errMessage = '';
        $scope.loginPassword = '';
        $scope.loginImageUrl = '../images/login-btn-n.png';
        $scope.http = 'http://qim.colocust.cn/api/';

        $scope.changStatus = function (status) {
            //切换界面后重置
            resetTimer(60, false, "获取验证码");
            $scope.status = status;
        };

        $scope.$watch('loginPassword', function (newValue, oldValue) {
            $scope.loginImageUrl = newValue === "" ? '../images/login-btn-n.png' : '../images/login-btn.png';
        });

        //登录
        $scope.login = function () {
            if (!checkTelephone($scope.loginPhone)) return;

            if (!checkPassword($scope.loginPassword)) return;

            let req = {
                telephone: $scope.loginPhone,
                password: $scope.loginPassword,
            };

            $http({
                method: 'POST',
                url: `${$scope.http}UserLogin`,
                data: req
            }).then(function successCallback(response) {
                // 请求成功执行代码
                console.log('--api--GetCaptcha', response);
                let res = response.data;
                if (res.code === 200 && res.result === 2) {
                    window.location.href = 'home.html';
                    return;
                }
                if (res.result === 0) {
                    $scope.showErrMessage('该手机号未注册');
                    return;
                }
                if (res.result === 1) {
                    $scope.showErrMessage('密码错误');
                    return;
                }

            }, function errorCallback(err) {
                // 请求失败执行代码
                console.log('--api--GetCaptcha', err);
                $scope.showErrMessage('网络错误，请稍后重试')
            });
        };

        //获取验证码
        $scope.getCode = function () {
            if (!checkTelephone($scope.phone)) return;
            $http({
                method: 'POST',
                url: `${$scope.http}GetCaptcha`,
                data: {telephone: $scope.phone}
            }).then(function successCallback(response) {
                // 请求成功执行代码
                let res = response.data;

                if (res.code === 200 && res.result === 2) {
                    timer()
                }

                if (res.result === 0) {
                    $scope.showErrMessage('网络错误，请稍后重试');
                    return;
                }
                if (res.result === 1) {
                    $scope.showErrMessage('该手机号已经注册');
                    return;
                }
            }, function errorCallback(err) {
                // 请求失败执行代码
                $scope.showErrMessage('网络错误，请稍后重试')

            });
        };

        //注册
        $scope.register = function () {
            let req = {
                telephone: $scope.phone,
                captcha: Number($scope.code),
                password: $scope.passwordRegister,
            };

            if (!checkTelephone($scope.phone)) return;

            if (!checkCaptcha(Number($scope.code))) return;

            if (!checkPassword($scope.passwordRegister)) return;

            $http({
                method: 'POST',
                url: `${$scope.http}RegisterUser`,
                data: req
            }).then(function successCallback(response) {
                // 请求成功执行代码

                let res = response.data;
                if (res.code === 200 && res.result === 3) {
                    $scope.changStatus('login');
                    return;
                }
                if (res.result === 0) {
                    $scope.showErrMessage('该手机号已经注册');
                    return;
                }
                if (res.result === 1) {
                    $scope.showErrMessage('验证码错误');
                    return;
                }
                if (res.result === 2) {
                    $scope.showErrMessage('网络错误，请稍后重试');
                    return;
                }

            }, function errorCallback(err) {
                // 请求失败执行代码
                $scope.showErrMessage('网络错误，请稍后重试')
            });
        };

        function timer() {
            $scope.codeTimerShow = true;
            interval.then();
        }

        let interval = $interval(function () {
            $scope.codeTimer > 0 ? $scope.codeTimer-- : resetTimer(60, false, "重新获取");
        }, 1000);

        function resetTimer(codeTimer, codeTimerShow, codeTips) {
            $scope.codeTimer = codeTimer;
            $scope.codeTimerShow = codeTimerShow;
            $scope.codeTips = codeTips
        }

        //检测手机号
        function checkTelephone(telephone) {
            if (telephone === "") {
                $scope.showErrMessage('请输入手机号');
                return false;
            }

            let reg = /^[1][3,4,5,7,8][0-9]{9}$/;
            if (!reg.test(telephone)) {
                $scope.showErrMessage('请输入正确的手机号');
                return false;
            }
            return true;
        }

        function checkCaptcha(captcha) {
            if (captcha === "") {
                $scope.showErrMessage('请输入验证码');
                return false;
            }

            if (typeof captcha !== "number") {
                $scope.showErrMessage('验证码格式错误');
                return false;
            }
            return true;
        }

        function checkPassword(password) {
            if (password === "") {
                $scope.showErrMessage('请输入密码');
                return false;
            }
            return true;
        }

        $scope.hiddenMessage = function () {
            // $scope.badNetWord = false
        };

        $scope.showErrMessage = function (message) {
            $scope.errMessage = message;
            setTimeout(function () {
                $scope.errMessage = ''
            }, 1000)
        }
    });

</script>
</body>
</html>
